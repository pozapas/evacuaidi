<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="EvacuAIDi: An AI-Driven, Causal-Informed Framework for Probabilistic and Disability-Inclusive Evacuation Guidance - PhD Dissertation by Amir Rafe">
    <meta name="keywords" content="AI evacuation, disability-inclusive design, emergency evacuation, fire safety, building safety, PhD dissertation">
    <meta name="author" content="Amir Rafe">
    <title>EvacuAIDi: An AI-Driven, Causal-Informed Framework for Probabilistic and Disability-Inclusive Evacuation Guidance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Same CSS styles as original -->
    <style>
        /* Copy all the CSS from the original index.html here */
        /* For brevity, I'm not including the full CSS, but it should be identical */
    </style>
</head>
<body class="antialiased">
    <!-- Copy all the HTML structure from the original index.html -->
    <!-- For brevity, I'm focusing on the JavaScript changes -->

<!-- Load Configuration for GitHub Pages (Secure) -->
<script src="api-config-secure.js"></script>

<script>
// Updated JavaScript for secure backend integration
document.addEventListener('DOMContentLoaded', function () {
    // All the original functionality plus secure backend integration
    
    // Initialize secure API client
    let secureApiClient;
    
    // Chat functionality with secure backend
    let chatHistory = [];
    let dissertationChunks = [];
    let chunkEmbeddings = [];
    let isIndexingComplete = false;

    // Comprehensive dissertation content (same as original)
    const dissertationContent = `EVACUAIDI: AN AI-DRIVEN, CAUSAL-INFORMED FRAMEWORK...`; // Copy from original

    // Advanced text chunking (same as original)
    function chunkText(text, chunkSize = 800, overlap = 200) {
        // Copy from original implementation
    }

    // Secure embedding generation using backend
    async function generateEmbedding(text) {
        try {
            if (!secureApiClient) {
                console.error('Secure API client not initialized');
                return null;
            }
            return await secureApiClient.generateEmbedding(text);
        } catch (error) {
            console.error('Error generating embedding:', error);
            return null;
        }
    }

    // Calculate cosine similarity (same as original)
    function cosineSimilarity(a, b) {
        // Copy from original implementation
    }

    // Retrieve relevant chunks using secure backend
    async function retrieveRelevantChunks(query, topK = 5) {
        if (!isIndexingComplete) {
            return dissertationChunks.slice(0, 3);
        }
        
        const queryEmbedding = await generateEmbedding(query);
        if (!queryEmbedding) {
            return dissertationChunks.slice(0, 3);
        }
        
        const similarities = chunkEmbeddings.map((embedding, index) => ({
            chunk: dissertationChunks[index],
            similarity: cosineSimilarity(queryEmbedding, embedding),
            index
        }));
        
        return similarities
            .sort((a, b) => b.similarity - a.similarity)
            .slice(0, topK)
            .map(item => item.chunk);
    }

    // Initialize RAG system with secure backend
    async function initializeRAG() {
        try {
            // Initialize secure API client
            secureApiClient = new SecureApiClient(CONFIG.API_BASE_URL);
            
            // Test backend connection
            const envConfig = new EnvConfig();
            const connected = await envConfig.loadEnv();
            
            if (!connected) {
                throw new Error('Failed to connect to secure backend');
            }
            
            console.log('Secure backend connected, starting RAG initialization...');
            
            // Create chunks from dissertation content
            dissertationChunks = chunkText(dissertationContent);
            console.log(`Created ${dissertationChunks.length} chunks for RAG system`);
            
            // Generate embeddings for all chunks using secure backend
            chunkEmbeddings = [];
            for (let i = 0; i < dissertationChunks.length; i++) {
                const embedding = await generateEmbedding(dissertationChunks[i].text);
                chunkEmbeddings.push(embedding);
                
                // Rate limiting: wait 100ms between requests
                if (i < dissertationChunks.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Update progress
                if (i % 5 === 0) {
                    console.log(`Indexed ${i + 1}/${dissertationChunks.length} chunks`);
                }
            }
            
            isIndexingComplete = true;
            console.log('RAG indexing complete!');
            
            // Update chat interface
            const welcomeMessage = document.querySelector('.chat-message p');
            if (welcomeMessage) {
                welcomeMessage.innerHTML += '<br><br><em>✅ Secure AI system ready!</em>';
            }
            
        } catch (error) {
            console.error('Error initializing secure RAG system:', error);
            isIndexingComplete = false;
            
            // Update chat interface to show error
            const welcomeMessage = document.querySelector('.chat-message p');
            if (welcomeMessage) {
                if (error.message.includes('backend')) {
                    welcomeMessage.innerHTML += '<br><br><em style="color: #ef4444;">❌ Backend connection failed. Please check deployment.</em>';
                } else {
                    welcomeMessage.innerHTML += '<br><br><em style="color: #ef4444;">❌ Initialization failed. The AI assistant may not work properly.</em>';
                }
            }
        }
    }

    // Initialize RAG system on page load
    initializeRAG();

    // Secure chat handler
    const handleChat = async () => {
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send');
        const userMessage = chatInput.value.trim();
        
        if (!userMessage) return;

        chatInput.value = '';
        chatSendBtn.disabled = true;
        appendMessage(userMessage, 'user');
        
        chatHistory.push({
            role: "user", 
            content: userMessage
        });

        // Add typing indicator
        const typingId = appendTypingIndicator();

        try {
            if (!secureApiClient) {
                throw new Error('Secure API client not initialized');
            }
            
            // Step 1: Retrieve relevant chunks using secure RAG
            const relevantChunks = await retrieveRelevantChunks(userMessage, 4);
            
            // Step 2: Prepare context from relevant chunks
            const ragContext = relevantChunks.map(chunk => chunk.text).join('\n\n');
            
            // Step 3: Generate response using secure backend
            const botMessage = await secureApiClient.generateResponse(userMessage, ragContext);
            
            removeTypingIndicator(typingId);
            
            chatHistory.push({
                role: "assistant", 
                content: botMessage
            });
            
            appendMessage(botMessage, 'bot');

        } catch (error) {
            removeTypingIndicator(typingId);
            console.error('Secure Chat Error:', error);
            
            let errorMessage = `I apologize, but I'm currently experiencing technical difficulties. However, here are some key findings from the EvacuAIDi research:

**Core Research Question:** How can AI-driven guidance systems improve evacuation safety and inclusivity?

**Major Findings:**
• AI guidance causes a **22.5% reduction in evacuation time**
• Benefits are **15.9% stronger for people with disabilities**
• **Occupant load (57%)** and **AI compliance (29%)** are the primary risk drivers
• The research was validated using real evacuation drill data from USU

For more comprehensive answers, please contact **Amir Rafe** directly at **amir.rafe@usu.edu**`;
            
            appendMessage(errorMessage, 'bot');
        } finally {
            chatSendBtn.disabled = false;
        }
    };

    // Rest of the JavaScript functions (same as original)
    // appendMessage, appendTypingIndicator, removeTypingIndicator, etc.
    
    // Event listeners
    const chatSendBtn = document.getElementById('chat-send');
    const chatInput = document.getElementById('chat-input');
    
    if (chatSendBtn) chatSendBtn.addEventListener('click', handleChat);
    if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleChat();
            }
        });
    }

    // Quick question buttons
    document.querySelectorAll('.quick-question').forEach(button => {
        button.addEventListener('click', (e) => {
            if (chatInput) {
                chatInput.value = e.target.textContent;
                handleChat();
            }
        });
    });

    // All other original functionality (navigation, animations, etc.)
});
</script>
</body>
</html>
